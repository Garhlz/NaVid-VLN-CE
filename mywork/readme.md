# RoboBrain 迁移与 NaVid 指令调优尝试

工作主要分为两个部分：尝试将通用的 **RoboBrain (Qwen2.5-VL) 模型**直接应用于VLN任务，以及对专用的 **NaVid 模型**进行免训练的指令调优。代码需移动到项目根目录运行

## Part 1: RoboBrain 模型迁移实验

### 目标
验证通用的 [RoboBrain](./robobrain/) 模型在不修改模型架构或者微调的前提下，通过少样本提示（Few-shot Prompting）直接解决VLN任务的能力。

### 方法
-   使用 RoboBrain 官方的 [`inference.py`](./robobrain/inference.py) 代码, 按照navid_agent.py修改为了[`robobrain_agent.py`](./robobrain/robobrain_agent.py) 
-   设计了遵循 Qwen-VL 指令格式的 Prompt，通过提供示例来约束模型输出特定的动作指令（如前进、左转、右转、停止）。

### 实验发现与挑战
1.  **静态推理能力验证**：在处理单张图片或短视频时，模型展现了出色的理解和遵循指令的能力。
2.  **动态推理的瓶颈**：当应用于VLN任务所需的实时视频流时，RoboBrain 的原生架构遇到了严重瓶颈：
    -   **显存限制**：模型需要将多帧历史图像作为输入。即便显著降低图像分辨率，显存占用依然会迅速超出硬件（4090）上限。
    -   **推理延迟**：处理多帧图像导致单步决策的耗时过长，无法满足实时导航的需求。

### 结论与未来方向
直接迁移通用多模态模型处理长时序、多帧输入的VLN任务是不可行的。

一个潜在的解决方案是借鉴 LLaMA-ViD 或 NaVid 的思想：修改模型架构，在 Vision Transformer (ViT) 的输出端加入 `grid-pool` 等压缩模块，将每帧画面的视觉特征压缩为少数几个 Token（例如，NaVid 中历史帧使用 4+1 Tokens，当前帧使用 64+1 Tokens）。

然而，此方案需要对 Qwen-VL 的模型架构进行修改并进行相应的重新训练，考虑到工作量巨大，已暂时搁置。

## Part 2: NaVid 模型指令调优实验

### 目标
在无法承担大规模重新训练成本的背景下，探索通过指令调优（Prompt Engineering）的方式，在不改动模型权重的前提下，提升 NaVid 模型的性能。核心思路是通过向模型显式地提供历史动作信息，增强其对自身决策的记忆能力。

### 实验设计
设计了两种不同的“记忆注入”方案：

1.  **[方案一：文本记忆注入](./input_history/)**：将历史动作序列（如 `[前进, 左转, 左转]`）转换为自然语言，直接整合到 Prompt 中。
2.  **[方案二：视觉记忆注入](./vision_info/)**：将上一步执行的动作，以视觉符号（图标或文字）的形式，叠加在当前输入帧的画面上。

### 实验发现与关键洞察
-   **Prompt 结构的敏感性**：实验发现，NaVid 模型对 Prompt 的结构高度敏感。任何大幅度的修改，例如提供详细的任务说明、给出完整的任务示例，都会**显著降低模型性能**。我推断，这是因为模型在微调阶段，其输入和输出已被严格地“格式化”，任何“域外”的 Prompt 结构都会被模型视为噪声，从而难以理解。
-   **最小化改动原则**：基于上述发现，后续所有 Prompt 修改都遵循“最小化注入”原则，即在最大程度上保留原始 Prompt 结构，仅在其中添加最少的必要信息。

### 各方案结果分析
-   **方案一 (文本记忆)**：
    -   遇到了 Token 数量超限的问题，通过采用固定大小的“滑动窗口”来只输入最近的N个动作，解决了此问题。
    -   **最终结果**：与基线相比，此方案导致了模型性能的**轻微下降**。

-   **方案二 (视觉记忆)**：
    -   **纯视觉提示**：仅在图像上叠加图标或文字，而不修改 Prompt，模型性能同样出现了**轻微下降**。
    -   **视觉+语言提示**：在图像上叠加图标的同时，在 Prompt 中加入一句简短的提示，最终取得了**微小的性能提升**。

| 不同方案对比 | TL (轨迹长度) | NE (导航误差) | OS (Oracle成功率) | SR (成功率) | SPL (路径长度加权成功率) |
| :--- | :---: | :---: | :---: | :---: | :---: |
| NaVid on VLN-CE R2R Val (Baseline) | 10.7 | 5.65 | 49.2% | 41.9% | 36.5% |
| 将过去决策文本加入到Prompt中 (最近几条) | 10.894 | 6.141 | 51.7% | 40.0% | 34.1% |
| 将上一帧决策用符号形式融合到当前帧上 | 9.333 | 5.76 | 46.5% | 40.1% | 35.8% |
| 将上一帧决策用符号形式融合到当前帧上, 同时修改Prompt(没有测试完) | 9.75 | 5.645 | 48.5% | 42.7% | 38.3% |